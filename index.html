<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BUTTS IN SEATS</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="loading" class="loading">DRUMROLL</div>
  <div id="error" class="error" hidden></div>

  <div id="dashboard" hidden>
    <div class="main-screen">
      <section class="data-section">
        <p class="intro-text">LAST WEEK THERE WERE</p>

        <div class="main-stats">
          <div class="stat-item">
            <p id="attendance" class="stat-number">-</p>
            <p class="stat-label">BUTTS IN</p>
          </div>
          <div class="stat-item">
            <p id="capacity" class="stat-number">-</p>
            <p class="stat-label">SEATS</p>
          </div>
          <div class="stat-item">
            <p id="percentage" class="stat-number">-</p>
            <p class="stat-label">FILLED</p>
          </div>
        </div>
      </section>
    </div>

    <section class="comparison-section">
      <p class="comparison-intro">
        THIS WEEK IN
        <select id="year-select">
          <option value="2024">2024</option>
          <option value="2023">2023</option>
          <option value="2022">2022</option>
          <option value="2021">2021</option>
          <option value="2020">2020</option>
          <option value="2019">2019</option>
          <option value="2018">2018</option>
          <option value="2017">2017</option>
          <option value="2016">2016</option>
          <option value="2015">2015</option>
        </select>
      </p>

      <div class="historical-stats">
        <div class="historical-stat">
          <p id="historical-attendance" class="historical-number">-</p>
          <p class="historical-label">BUTTS IN</p>
        </div>
        <div class="historical-stat">
          <p id="historical-capacity" class="historical-number">-</p>
          <p class="historical-label">SEATS</p>
        </div>
        <div class="historical-stat">
          <p id="historical-percentage" class="historical-number">-</p>
          <p class="historical-label">FILLED</p>
        </div>
      </div>
    </section>

    <footer class="metadata">
      <p id="week-ending">Week ending: -</p>
      <p id="last-updated">Last updated: -</p>
      <p>
        Data source:
        <a
          href="https://www.broadwayworld.com/grosses.cfm"
          target="_blank"
          rel="noopener noreferrer"
          >BROADWAYWORLD</a
        >
      </p>
      <button id="theme-toggle" aria-label="Toggle dark theme">ðŸŒ“</button>
    </footer>
  </div>

  <script>
    console.log("Script starting...");
    class BroadwayDashboard {
      constructor() {
        this.init();
      }

      async init() {
        await this.loadCurrentData();
        this.setupYearSelector();
        this.setupThemeToggle();
      }

      async loadCurrentData() {
        try {
          const res = await fetch("/.netlify/functions/broadway-data");
          const data = await res.json();

          document.getElementById("attendance").textContent =
            data.attendance.toLocaleString();
          document.getElementById("capacity").textContent =
            data.capacity.toLocaleString();
          document.getElementById("percentage").textContent =
            data.percentage + "%";
          document.getElementById("week-ending").textContent =
            "Week ending: " + data.weekEnding;
          document.getElementById("last-updated").textContent =
            "Last updated: " + data.lastUpdated;

          document.getElementById("loading").remove();
          document.getElementById("dashboard").hidden = false;
        } catch (err) {
          // Fallback to mock data for local development
          console.log("API failed, using mock data:", err);
          this.loadMockData();
        }
      }

      loadMockData() {
        const mockData = {
          attendance: 217600,
          capacity: 256000,
          percentage: 85,
          weekEnding: new Date().toLocaleDateString('en-US', { 
            month: 'long', 
            day: 'numeric', 
            year: 'numeric' 
          }),
          lastUpdated: new Date().toLocaleString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            timeZone: 'America/New_York'
          })
        };

        document.getElementById("attendance").textContent =
          mockData.attendance.toLocaleString();
        document.getElementById("capacity").textContent =
          mockData.capacity.toLocaleString();
        document.getElementById("percentage").textContent =
          mockData.percentage + "%";
        document.getElementById("week-ending").textContent =
          "Week ending: " + mockData.weekEnding;
        document.getElementById("last-updated").textContent =
          "Last updated: " + mockData.lastUpdated;

        document.getElementById("loading").remove();
        document.getElementById("dashboard").hidden = false;
      }

      setupYearSelector() {
        const select = document.getElementById("year-select");
        console.log("Setting up year selector, initial value:", select.value);
        select.addEventListener("change", (e) => {
          console.log("Year changed to:", e.target.value);
          this.loadHistoricalData(e.target.value);
        });
        this.loadHistoricalData(select.value);
      }

      async loadHistoricalData(year) {
        try {
          const week = this.getCurrentWeekNumber();
          const res = await fetch(
            `/.netlify/functions/broadway-historical?year=${year}&week=${week}`
          );
          const data = await res.json();

          document.getElementById("historical-attendance").textContent =
            data.attendance.toLocaleString();
          document.getElementById("historical-capacity").textContent =
            data.capacity.toLocaleString();
          document.getElementById("historical-percentage").textContent =
            data.percentage + "%";
        } catch (err) {
          // Fallback to mock historical data
          console.log("Historical API failed, using mock data:", err);
          this.loadMockHistoricalData(year);
        }
      }

      loadMockHistoricalData(year) {
        console.log("Loading mock historical data for year:", year);
        // Generate realistic mock historical data
        const baseAttendance = 200000;
        const baseCapacity = 240000;
        
        // Vary data based on year (pre-pandemic vs post-pandemic)
        let multiplier = 1;
        if (year < 2020) multiplier = 1.1; // Pre-pandemic was higher
        if (year === 2020) multiplier = 0.3; // Pandemic year was much lower
        if (year === 2021) multiplier = 0.6; // Recovery year
        if (year === 2022) multiplier = 0.8; // More recovery
        if (year === 2023) multiplier = 0.95; // Near normal
        if (year === 2024) multiplier = 1.0; // Current year
        
        const mockData = {
          attendance: Math.round(baseAttendance * multiplier),
          capacity: Math.round(baseCapacity * multiplier),
          percentage: Math.round((baseAttendance / baseCapacity) * 100 * multiplier)
        };

        console.log("Mock data calculated:", mockData);

        document.getElementById("historical-attendance").textContent =
          mockData.attendance.toLocaleString();
        document.getElementById("historical-capacity").textContent =
          mockData.capacity.toLocaleString();
        document.getElementById("historical-percentage").textContent =
          mockData.percentage + "%";
        
        console.log("Historical data updated in DOM");
      }

      getCurrentWeekNumber() {
        const now = new Date();
        const start = new Date(now.getFullYear(), 0, 1);
        const days = Math.floor((now - start) / 86400000);
        return Math.ceil((days + start.getDay() + 1) / 7);
      }

      setupThemeToggle() {
        const btn = document.getElementById("theme-toggle");
        const root = document.documentElement;
        const stored = localStorage.getItem("theme");
        if (stored) root.setAttribute("data-theme", stored);

        btn.addEventListener("click", () => {
          const current = root.getAttribute("data-theme") === "dark"
            ? "light"
            : "dark";
          root.setAttribute("data-theme", current);
          localStorage.setItem("theme", current);
        });
      }

      showError(message) {
        document.getElementById("loading").remove();
        const err = document.getElementById("error");
        err.textContent = message;
        err.hidden = false;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      console.log("DOM loaded, creating dashboard...");
      new BroadwayDashboard();
    });
  </script>
</body>
</html>
