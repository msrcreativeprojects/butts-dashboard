<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BUTTS IN SEATS</title>
  
  <!-- Four-pointed star favicon -->
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/favicon.svg">
  
  <!-- Open Graph / Social Media Preview -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="BUTTS IN SEATS">
  <meta property="og:description" content="Live Broadway attendance tracking - see how many butts are in seats this week!">
  <meta property="og:image" content="/social-preview.jpg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="1200">
  <meta property="og:url" content="https://buttsinseats.xyz">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="BUTTS IN SEATS">
  <meta name="twitter:description" content="Live Broadway attendance tracking">
  <meta name="twitter:image" content="/social-preview.jpg">

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
    rel="stylesheet"
  />
  <script>
    (function() {
      try {
        var savedTheme = localStorage.getItem('theme') || 'blue';
        if (savedTheme === 'random') {
          var raw = localStorage.getItem('themeRandomVars');
          if (raw) {
            try {
              var vars = JSON.parse(raw);
              var root = document.documentElement;
              if (vars.blue) root.style.setProperty('--blue', vars.blue);
              if (vars.blueDark) root.style.setProperty('--blue-dark', vars.blueDark);
              if (vars.blueDarker) root.style.setProperty('--blue-darker', vars.blueDarker);
              if (vars.text) root.style.setProperty('--text', vars.text);
            } catch (e) {}
          } else {
            savedTheme = 'blue';
          }
        }
        document.documentElement.setAttribute('data-theme', savedTheme);
      } catch (e) {}
    })();
  </script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="loading-screen" class="loading-screen">
    <div class="loading-star">‚ú¶</div>
  </div>

  <div id="error" class="error" hidden></div>

  <div id="viewport-display" style="position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; z-index: 1000; font-family: monospace;"></div>

  <div id="dashboard">
    <div class="main-screen">
      <section class="data-section">
        <p id="intro-text" class="intro-text"></p>
      </section>
    </div>

    <section class="comparison-section">
      <div class="comparison-header">
        <p class="comparison-intro">
          <span class="intro-faded">THIS WEEK IN</span>
          <span class="year-dropdown">
            <span id="year-display" class="year-highlight"> 2023</span>
            <div id="year-dropdown-menu" class="year-dropdown-menu" hidden>
              <!-- Years will be populated by JavaScript -->
            </div>
          </span>
        </p>
        <p class="shows-running-text" id="historical-text">
          <span class="intro-faded">THERE WERE</span> 
          <span id="historical-shows-display" class="intro-highlight no-wrap">32 SHOWS</span><br>
          <span class="intro-faded">RUNNING AND</span> 
          <span id="historical-attendance-display" class="intro-highlight">217600</span><br>
          <span class="intro-faded no-wrap">BUTTS IN SEATS</span>
        </p>
      </div>
      


    </section>

    <footer class="metadata">
      <div class="footer-left">
        <a href="/waitlist.html" class="waitlist-cta">COUNT ME IN</a>
        <a href="http://fourthwall.news" target="_blank" rel="noopener noreferrer" class="read-more-cta read-more-mobile">READ MORE</a>
      </div>
      
      <div class="theme-selector">
        <div class="theme-option" data-theme="blue" title="Blue"></div>
        <div class="theme-option" data-theme="green" title="Green"></div>
        <div class="theme-option" data-theme="pink" title="Pink"></div>
        <button id="shuffle-theme" class="shuffle-button" title="Random Color">‚ú¶</button>
      </div>
      
      <!-- Share button - positioned differently on desktop vs mobile -->
      <button id="share-button" class="share-button" title="Share to Instagram Story">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M7 17L17 7"/>
          <path d="M7 7h10v10"/>
        </svg>
      </button>
      
      <button id="preview-button" class="preview-button" title="Preview Share Image">
        üëÅÔ∏è
      </button>
      
      <div class="footer-center">
        <div class="fourth-wall-attribution" style="opacity: 0.8;">
          A <a href="http://fourthwall.news" target="_blank" rel="noopener noreferrer"><strong>Fourth Wall</strong></a> Project
        </div>
      </div>
      
      <div class="footer-right">
        <a href="http://fourthwall.news" target="_blank" rel="noopener noreferrer" class="read-more-cta read-more-desktop">READ MORE</a>
      </div>
      <!-- Hidden elements for functionality -->
      <div style="display: none;">
        <span id="week-ending">-</span>
        <span id="last-updated">-</span>
        <button id="theme-toggle" aria-label="Toggle dark theme">üåì</button>
      </div>
    </footer>
  </div>

  <script>
    console.log("Script starting...");
    class BroadwayDashboard {
      constructor() {
        this.init();
      }

      async init() {
        await this.loadCurrentData();
        this.setupYearSelector();
        this.setupThemeSelector();
        this.setupShareButton();
        this.setupViewportTracker();
        this.setupDebugInfo();
        this.setupShuffleTheme();
        this.generateSocialPreview();
        this.hideLoadingScreen();
      }

      hideLoadingScreen() {
        const loadingScreen = document.getElementById('loading-screen');
        // Add a small delay to ensure smooth transition
        setTimeout(() => {
          loadingScreen.classList.add('hidden');
          // Remove from DOM after transition completes
          setTimeout(() => {
            loadingScreen.remove();
          }, 500);
        }, 800); // Show loading for at least 800ms for brand visibility
      }

      setupViewportTracker() {
        const widthElement = document.getElementById("viewport-display");
        
        // Only show viewport width in local development
        const isLocal = location.hostname === 'localhost' || 
                       location.hostname === '127.0.0.1' || 
                       location.port !== '';
        
        if (isLocal) {
          const updateWidth = () => {
            const width = window.innerWidth;
            widthElement.textContent = `Width: ${width}px`;
          };
          
          updateWidth();
          window.addEventListener('resize', updateWidth);
        } else {
          // Hide on production
          widthElement.style.display = 'none';
        }
      }

      setupDebugInfo() {
        // Add debug info for local development
        const isLocal = location.hostname === 'localhost' || 
                       location.hostname === '127.0.0.1' || 
                       location.port !== '';
        
        if (false) { // Debug panel disabled
          const debugPanel = document.createElement('div');
          debugPanel.id = 'debug-panel';
          debugPanel.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            z-index: 999;
            backdrop-filter: blur(8px);
            line-height: 1.4;
          `;
          
          const updateDebugInfo = () => {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const attendanceEl = document.getElementById("attendance-number");
            const attendanceSize = attendanceEl ? window.getComputedStyle(attendanceEl).fontSize : 'N/A';
            
            debugPanel.innerHTML = `
              Attendance font: ${attendanceSize}<br>
              12vh = ${Math.round(height * 0.12)}px<br>
              2vh = ${Math.round(height * 0.02)}px
            `;
          };
          
          updateDebugInfo();
          window.addEventListener('resize', updateDebugInfo);
          document.body.appendChild(debugPanel);
        }
      }

      setupShuffleTheme() {
        const shuffleButton = document.getElementById('shuffle-theme');
        shuffleButton.addEventListener('click', () => {
          // Add spin animation
          shuffleButton.classList.add('spinning');
          
          // Remove animation class after it completes
          setTimeout(() => {
            shuffleButton.classList.remove('spinning');
          }, 400);
          
          this.generateRandomTheme();
        });
      }

      async generateRandomTheme() {
        // Generate diverse, appealing color directly without API dependency
        this.generateDiverseTheme();
      }

      darkenColor(rgb, factor) {
        const [r, g, b] = rgb;
        return `rgb(${Math.floor(r * factor)}, ${Math.floor(g * factor)}, ${Math.floor(b * factor)})`;
      }

      getContrastColor(rgb) {
        // Calculate luminance
        const [r, g, b] = rgb;
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
        return luminance > 0.5 ? '#000000' : '#ffffff';
      }

      applyRandomTheme(color1, color2, color3, textColor) {
        const root = document.documentElement;
        
        // Apply CSS custom properties
        root.style.setProperty('--blue', color1);
        root.style.setProperty('--blue-dark', color2);
        root.style.setProperty('--blue-darker', color3);
        root.style.setProperty('--text', textColor);
        
        // Persist random theme
        try {
          localStorage.setItem('theme', 'random');
          localStorage.setItem('themeRandomVars', JSON.stringify({
            blue: color1,
            blueDark: color2,
            blueDarker: color3,
            text: textColor
          }));
        } catch (e) {}
        
        // Set data-theme to trigger any theme-specific styles
        document.documentElement.setAttribute('data-theme', 'random');
        
        // Clear active state from theme options
        document.querySelectorAll('.theme-option').forEach(option => {
          option.classList.remove('active');
        });
        
        // Highlight shuffle button briefly
        const shuffleButton = document.getElementById('shuffle-theme');
        shuffleButton.style.background = 'rgba(255, 255, 255, 0.4)';
        setTimeout(() => {
          shuffleButton.style.background = 'rgba(255, 255, 255, 0.1)';
        }, 300);
      }

      generateDiverseTheme() {
        // Initialize or retrieve recent colors from session storage
        if (!this.recentColors) {
          this.recentColors = JSON.parse(sessionStorage.getItem('recentColors') || '[]');
        }
        
        let attempts = 0;
        let newHue;
        
        // Try to find a hue that's different from recent colors
        do {
          newHue = Math.floor(Math.random() * 360);
          attempts++;
        } while (attempts < 20 && this.isTooSimilarToRecent(newHue));
        
        // Curated ranges for appealing colors
        const saturationRanges = [
          [65, 85],   // Vibrant but not overwhelming
          [45, 65],   // Rich and sophisticated
          [75, 90]    // Bold and energetic
        ];
        
        const lightnessRanges = [
          [35, 50],   // Deep and rich
          [50, 65],   // Balanced and pleasant
          [40, 55]    // Warm and inviting
        ];
        
        // Randomly select ranges for variety
        const satRange = saturationRanges[Math.floor(Math.random() * saturationRanges.length)];
        const lightRange = lightnessRanges[Math.floor(Math.random() * lightnessRanges.length)];
        
        const saturation = satRange[0] + Math.random() * (satRange[1] - satRange[0]);
        const lightness = lightRange[0] + Math.random() * (lightRange[1] - lightRange[0]);
        
        // Generate color variations
        const color1 = `hsl(${newHue}, ${saturation}%, ${lightness}%)`;
        const color2 = `hsl(${newHue}, ${Math.max(saturation - 10, 30)}%, ${Math.max(lightness - 12, 25)}%)`;
        const color3 = `hsl(${newHue}, ${Math.max(saturation - 15, 25)}%, ${Math.max(lightness - 20, 20)}%)`;
        
        // Store this hue for future diversity checks
        this.recentColors.push(newHue);
        if (this.recentColors.length > 8) {
          this.recentColors.shift(); // Keep only last 8 colors
        }
        sessionStorage.setItem('recentColors', JSON.stringify(this.recentColors));
        
        this.applyRandomTheme(color1, color2, color3, '#ffffff');
      }
      
      isTooSimilarToRecent(newHue) {
        if (!this.recentColors || this.recentColors.length === 0) return false;
        
        return this.recentColors.some(recentHue => {
          // Calculate hue distance (accounting for circular nature of hue)
          const distance = Math.min(
            Math.abs(newHue - recentHue),
            360 - Math.abs(newHue - recentHue)
          );
          return distance < 45; // Require at least 45¬∞ difference
        });
      }

      generateSocialPreview() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Get current theme colors
        const bodyStyles = getComputedStyle(document.body);
        const bgColor = bodyStyles.getPropertyValue('--blue').trim() || '#0052cc';
        const textColor = bodyStyles.getPropertyValue('--text').trim() || '#ffffff';
        
        // Get just the main attendance text (not footer)
        const introText = document.getElementById('intro-text')?.textContent || 'BUTTS IN SEATS';
        const words = introText.trim().split(' ');
        
        // Calculate optimal font size and dimensions  
        const maxWidth = 1200;
        const padding = 40; // Reduced padding
        const fontSize = 120;
        const lineHeight = fontSize * 1.1;
        
        ctx.font = `900 ${fontSize}px Inter, -apple-system, system-ui, sans-serif`;
        
        // Group words into lines that fit within maxWidth
        const lines = [];
        let currentLine = '';
        
        words.forEach(word => {
          const testLine = currentLine ? `${currentLine} ${word}` : word;
          const metrics = ctx.measureText(testLine);
          
          if (metrics.width <= maxWidth - (padding * 2)) {
            currentLine = testLine;
          } else {
            if (currentLine) lines.push(currentLine);
            currentLine = word;
          }
        });
        if (currentLine) lines.push(currentLine);
        
        // Calculate canvas dimensions based on text
        const textWidth = Math.max(...lines.map(line => ctx.measureText(line).width));
        const textHeight = lines.length * lineHeight;
        
        canvas.width = Math.max(textWidth + (padding * 2), 600);
        canvas.height = textHeight + padding + (padding * 0.5); // Less bottom padding
        
        // Redraw with final dimensions
        ctx.font = `900 ${fontSize}px Inter, -apple-system, system-ui, sans-serif`;
        ctx.fillStyle = bgColor;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = textColor;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        
        // Draw each line
        lines.forEach((line, index) => {
          const x = canvas.width / 2;
          const y = padding + (index * lineHeight);
          ctx.fillText(line, x, y);
        });
        
        // Convert to blob and create URL
        canvas.toBlob((blob) => {
          if (blob) {
            const url = URL.createObjectURL(blob);
            // Update meta tag
            const ogImage = document.querySelector('meta[property="og:image"]');
            const twitterImage = document.querySelector('meta[name="twitter:image"]');
            if (ogImage) ogImage.content = url;
            if (twitterImage) twitterImage.content = url;
            
            // Update dimensions in meta tags
            const ogWidth = document.querySelector('meta[property="og:image:width"]');
            const ogHeight = document.querySelector('meta[property="og:image:height"]');
            if (ogWidth) ogWidth.content = canvas.width;
            if (ogHeight) ogHeight.content = canvas.height;
          }
        }, 'image/jpeg', 0.95);
      }

      async loadCurrentData() {
        try {
          const fetchPromise = fetch("/.netlify/functions/broadway-data");
          const timeoutPromise = new Promise((_, reject) =>
            setTimeout(() => reject(new Error("Request timed out")), 15000)
          );
          const res = await Promise.race([fetchPromise, timeoutPromise]);
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          const data = await res.json();

          this.updateMainDisplay(data);
        } catch (err) {
          console.error("Failed to load Broadway data:", err);
          // Use fallback data for demo purposes with current Broadway week ending (8/31/2025)
          const broadwayWeekEnding = new Date('8/31/2025');
          const fallbackData = {
            attendance: 237539, // Match current live data
            showCount: 34,
            weekEnding: broadwayWeekEnding.toLocaleDateString('en-US', {
              month: 'long', day: 'numeric', year: 'numeric'
            }),
            lastUpdated: broadwayWeekEnding.toLocaleDateString('en-US', {
              weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            })
          };
          this.updateMainDisplay(fallbackData);
        }
      }

      formatAttendance(number) {
        return number.toLocaleString().replace(/,/g, '');
      }

      updateMainDisplay(data) {
        document.getElementById("intro-text").innerHTML =
          `<span class="intro-faded">LAST WEEK</span><br>` +
          `<span class="intro-faded">THERE WERE</span><br>` +
          `<span class="intro-highlight no-wrap">${data.showCount.toLocaleString()} SHOWS</span><br>` +
          `<span class="intro-faded">RUNNING AND</span><br>` +
          `<span class="intro-highlight attendance-large" id="attendance-number">000000</span><br>` +
          `<span class="intro-faded no-wrap">BUTTS IN SEATS</span>`;

        document.getElementById("week-ending").textContent = data.weekEnding;
        document.getElementById("last-updated").textContent = data.lastUpdated;
        
        // Animate the attendance number
        this.animateAttendanceNumber(data.attendance);
        
        // Generate social preview after display updates
        setTimeout(() => this.generateSocialPreview(), 500);
      }

      animateAttendanceNumber(finalNumber) {
        const element = document.getElementById("attendance-number");
        const finalString = this.formatAttendance(finalNumber);
        const duration = 2000; // 2 seconds
        const updateInterval = 120; // Update every 120ms for crisp posterized effect
        
        // Find all digit positions
        const digitPositions = [];
        for (let i = 0; i < finalString.length; i++) {
          if (finalString[i].match(/\d/)) {
            digitPositions.push(i);
          }
        }
        
        const totalDigits = digitPositions.length;
        const stepsPerDigit = Math.ceil(duration / (updateInterval * totalDigits));
        let currentStep = 0;
        let lockedDigitCount = 0;
        
        const animate = () => {
          currentStep++;
          
          // Determine which digit should lock next
          const digitToLock = Math.floor((currentStep - 1) / stepsPerDigit);
          if (digitToLock > lockedDigitCount - 1 && lockedDigitCount < totalDigits) {
            lockedDigitCount = digitToLock + 1;
          }
          
          let displayNumber = '';
          let digitIndex = 0;
          
          for (let i = 0; i < finalString.length; i++) {
            if (finalString[i].match(/\d/)) {
              if (digitIndex < lockedDigitCount) {
                // Digit is locked - show correct value
                displayNumber += finalString[i];
              } else {
                // Digit is still scrambling
                displayNumber += Math.floor(Math.random() * 10);
              }
              digitIndex++;
            } else {
              // Keep non-digit characters as is
              displayNumber += finalString[i];
            }
          }
          
          element.textContent = displayNumber;
          
          // Continue animation until all digits are locked
          if (lockedDigitCount < totalDigits) {
            setTimeout(animate, updateInterval);
          } else {
            // Final frame - ensure we show the actual number
            element.textContent = finalString;
            // Trigger celebration!
            this.celebrateNumberReveal();
          }
        };
        
        // Start the animation
        setTimeout(animate, updateInterval);
      }
      
      easeOutQuart(t) {
        return 1 - Math.pow(1 - t, 4);
      }

      celebrateNumberReveal() {
        // Celebration disabled for now - uncomment to re-enable:
        // this.showCelebrationGif();
      }

      showCelebrationGif() {
        // Array of The Office celebration GIFs
        const celebrationGifs = [
          'https://media.giphy.com/media/5GoVLqeAOo6PK/giphy.gif', // Michael "YES!" 
          'https://media.giphy.com/media/yUI3a7RwLhOFy/giphy.gif', // Jim fist pump
          'https://media.giphy.com/media/g9582DNuQppxC/giphy.gif', // Michael party dancing
          'https://media.giphy.com/media/3ohzdIuqJoo8QdKlnW/giphy.gif', // Dwight celebrating
          'https://media.giphy.com/media/l1ughbsd9qXz2s9SE/giphy.gif', // Kevin dancing
          'https://media.giphy.com/media/8VrtCswiLDNnO/giphy.gif', // Pam cheering
          'https://media.giphy.com/media/IwAZ6dvvvaTtdI8SD5/giphy.gif', // Office party dancing
          'https://media.giphy.com/media/BYhoMtJMQsYVy/giphy.gif' // Michael celebrating
        ];
        
        const randomGif = celebrationGifs[Math.floor(Math.random() * celebrationGifs.length)];
        
        // Create GIF overlay
        const gifOverlay = document.createElement('div');
        gifOverlay.className = 'celebration-gif-overlay';
        
        const gifImg = document.createElement('img');
        gifImg.src = randomGif;
        gifImg.className = 'celebration-gif';
        gifImg.alt = 'YES! Celebration!';
        
        gifOverlay.appendChild(gifImg);
        
        gifOverlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
          pointer-events: none;
          z-index: 1000;
          opacity: 0;
          animation: gifCelebration 2.5s ease-out forwards;
        `;
        
        gifImg.style.cssText = `
          width: 350px;
          height: 350px;
          object-fit: cover;
          box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4);
          transform: scale(0.8);
        `;
        
        document.body.appendChild(gifOverlay);
        
        // Remove after animation
        setTimeout(() => {
          if (gifOverlay.parentElement) {
            gifOverlay.parentElement.removeChild(gifOverlay);
          }
        }, 2500);
      }

      setupYearSelector() {
        const yearDisplay = document.getElementById("year-display");
        const dropdownMenu = document.getElementById("year-dropdown-menu");
        
        // Set initial year (2023)
        let currentYear = 2023;
        yearDisplay.textContent = ` ${currentYear}`;
        
        // Define year range  
        const minYear = 1996;
        const maxYear = 2024;
        
        // Populate dropdown with all years
        for (let year = maxYear; year >= minYear; year--) {
          const option = document.createElement('div');
          option.className = 'year-option';
          option.textContent = year;
          if (year === currentYear) {
            option.classList.add('selected');
          }
          option.addEventListener('click', () => {
            this.selectYear(year);
          });
          dropdownMenu.appendChild(option);
        }
        
        // Toggle dropdown on year click
        yearDisplay.addEventListener('click', () => {
          dropdownMenu.hidden = !dropdownMenu.hidden;
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.year-dropdown')) {
            dropdownMenu.hidden = true;
          }
        });
        
        // Load initial data
        this.loadHistoricalData(currentYear);
      }

      selectYear(year) {
        const yearDisplay = document.getElementById("year-display");
        const dropdownMenu = document.getElementById("year-dropdown-menu");
        
        // Update display
        yearDisplay.textContent = ` ${year}`;
        
        // Update selected option
        dropdownMenu.querySelectorAll('.year-option').forEach(option => {
          option.classList.toggle('selected', parseInt(option.textContent) === year);
        });
        
        // Close dropdown
        dropdownMenu.hidden = true;
        
        // Load historical data for selected year
        this.loadHistoricalData(year);
      }

      async loadHistoricalData(year) {
        try {
          const week = this.getCurrentWeekNumber();
          const res = await fetch(
            `/.netlify/functions/broadway-historical?year=${year}&week=${week}`
          );
          
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          const data = await res.json();

          document.getElementById("historical-shows-display").textContent =
            data.showCount.toLocaleString() + " SHOWS";
          document.getElementById("historical-attendance-display").textContent =
            this.formatAttendance(data.attendance);
        } catch (err) {
          console.error("Failed to load historical data:", err);
          
          // For local development, use sample data based on real historical patterns
          // This will be replaced by real API data in production
          const sampleData = this.getLocalHistoricalSample(year);
          
          document.getElementById("historical-shows-display").textContent =
            sampleData.showCount === "‚Äî" ? "‚Äî SHOWS" : sampleData.showCount.toLocaleString() + " SHOWS";
          document.getElementById("historical-attendance-display").textContent =
            sampleData.attendance === "‚Äî" ? "‚Äî" : this.formatAttendance(sampleData.attendance);
        }
      }

      getLocalHistoricalSample(year) {
        // Only real data - no made-up samples
        // Production uses real API calls to broadway-historical function
        const samples = {
          2016: { showCount: 29, attendance: 109724 }, // Real CSV data
          2017: { showCount: 28, attendance: 184399 }, // Real CSV data
          2018: { showCount: 30, attendance: 127459 }, // Real CSV data
          2019: { showCount: 31, attendance: 148857 }, // Real CSV data  
        };
        
        return samples[year] || { showCount: "‚Äî", attendance: "‚Äî" };
      }


      getCurrentWeekNumber() {
        const now = new Date();
        const start = new Date(now.getFullYear(), 0, 1);
        const days = Math.floor((now - start) / 86400000);
        return Math.ceil((days + start.getDay() + 1) / 7);
      }

      setupThemeSelector() {
        const root = document.documentElement;
        const themeOptions = document.querySelectorAll('.theme-option');
        
        // Get available themes from the DOM
        const availableThemes = Array.from(themeOptions).map(option => option.dataset.theme);
        
        // Load saved theme or default to blue, but ensure it's valid
        const savedTheme = localStorage.getItem("theme") || "blue";
        const validTheme = availableThemes.includes(savedTheme) ? savedTheme : "blue";
        root.setAttribute("data-theme", validTheme);
        
        // Set active state for current theme
        const updateActiveTheme = (activeTheme) => {
          themeOptions.forEach(option => {
            option.classList.toggle('active', option.dataset.theme === activeTheme);
          });
        };
        
        updateActiveTheme(validTheme);
        
        // Add click handlers for theme options
        themeOptions.forEach(option => {
          option.addEventListener('click', () => {
            const newTheme = option.dataset.theme;
            
            // Clear any custom CSS properties from random themes
            root.style.removeProperty('--blue');
            root.style.removeProperty('--blue-dark');
            root.style.removeProperty('--blue-darker');
            root.style.removeProperty('--text');
            
            // Set the theme
            root.setAttribute("data-theme", newTheme);
            localStorage.setItem("theme", newTheme);
            try { localStorage.removeItem('themeRandomVars'); } catch (e) {}
            updateActiveTheme(newTheme);
          });
        });
      }

      setupShareButton() {
        const shareButton = document.getElementById('share-button');
        const previewButton = document.getElementById('preview-button');
        
        shareButton.addEventListener('click', () => {
          this.generateShareImage();
        });
        
        previewButton.addEventListener('click', () => {
          this.previewShareImage();
        });
      }

      getCurrentThemeColors() {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'blue';
        const themes = {
          blue: { primary: '#0052cc', dark: '#003d99', text: '#fff' },
          green: { primary: '#0d7377', dark: '#14a085', text: '#fff' },
          pink: { primary: '#d63384', dark: '#b02a5b', text: '#fff' },
          white: { primary: '#ffffff', dark: '#f8f9fa', text: '#212529' },
          black: { primary: '#000000', dark: '#1a1a1a', text: '#ffffff' }
        };
        return themes[currentTheme];
      }

      generateShareImage() {
        const canvas = this.createShareImageCanvas();
        
        // Get current data for share text
        const attendanceEl = document.getElementById('attendance-number');
        const attendance = attendanceEl ? attendanceEl.textContent : '000000';
        
        const introText = document.getElementById('intro-text').innerHTML;
        const showCountMatch = introText.match(/(\d+) SHOWS/);
        const showCount = showCountMatch ? showCountMatch[1] : '0';
        
        // Convert canvas to blob and download/share
        canvas.toBlob((blob) => {
          if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([blob], 'broadway-attendance.jpg', { type: 'image/jpeg' })] })) {
            // Use Web Share API if available (mobile)
            const file = new File([blob], 'broadway-attendance.jpg', { type: 'image/jpeg' });
            navigator.share({
              title: 'Broadway Attendance',
              text: `Last week there were ${showCount} shows running and ${attendance} butts in seats!`,
              files: [file]
            }).catch(console.error);
          } else {
            // Fallback: download the image
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'broadway-attendance.jpg';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
          }
        }, 'image/jpeg', 0.95);
      }

      previewShareImage() {
        const canvas = this.createShareImageCanvas();
        
        // Convert to data URL for preview
        const dataURL = canvas.toDataURL('image/png');
        
        // Create preview overlay
        const overlay = document.createElement('div');
        overlay.className = 'image-preview-overlay';
        
        const container = document.createElement('div');
        container.className = 'image-preview-container';
        
        const img = document.createElement('img');
        img.src = dataURL;
        img.alt = 'Share Image Preview';
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'preview-close-btn';
        closeBtn.innerHTML = '√ó';
        closeBtn.addEventListener('click', () => {
          document.body.removeChild(overlay);
        });
        
        container.appendChild(img);
        container.appendChild(closeBtn);
        overlay.appendChild(container);
        
        // Close on overlay click
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            document.body.removeChild(overlay);
          }
        });
        
        // Close on Escape key
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            document.body.removeChild(overlay);
            document.removeEventListener('keydown', handleEscape);
          }
        };
        document.addEventListener('keydown', handleEscape);
        
        document.body.appendChild(overlay);
      }

      createShareImageCanvas() {
        // Get current attendance data
        const attendanceEl = document.getElementById('attendance-number');
        const attendance = attendanceEl ? attendanceEl.textContent : '000000';
        
        // Get current show count
        const introText = document.getElementById('intro-text').innerHTML;
        const showCountMatch = introText.match(/(\d+) SHOWS/);
        const showCount = showCountMatch ? showCountMatch[1] : '0';
        
        // Get current theme colors
        const colors = this.getCurrentThemeColors();
        
        // Create canvas for Instagram Story dimensions
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = 1080;
        canvas.height = 1920;
        
        // Fill background with theme color
        ctx.fillStyle = colors.primary;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Add subtle grain texture
        ctx.globalAlpha = 0.03;
        for (let i = 0; i < 3000; i++) {
          const x = Math.random() * canvas.width;
          const y = Math.random() * canvas.height;
          ctx.fillStyle = colors.text;
          ctx.fillRect(x, y, 1, 1);
        }
        ctx.globalAlpha = 1;
        
        // Set text properties
        ctx.fillStyle = colors.text;
        ctx.textAlign = 'left';
        ctx.textBaseline = 'alphabetic';
        
        // Better font sizes - 25% larger (split the difference)
        const introFontSize = Math.round(85 * 1.25); // 106px
        const attendanceFontSize = Math.round(160 * 1.25); // 200px
        const leftMargin = Math.round(60 * 1.25); // 75px
        
        // Tighter spacing that matches the site better
        const introSpacing = introFontSize * 0.9 + 5; // Close to CSS line-height: 0.9 with small buffer
        const attendanceSpacing = attendanceFontSize * 0.9 + 15; // Attendance gets a bit more buffer
        
        // Center the text block vertically in the 1920px height frame
        // Estimate total height needed and start from center
        const totalTextHeight = (introSpacing * 4) + (attendanceSpacing) + 60; // Rough estimate
        const centerY = (canvas.height - totalTextHeight) / 2;
        let currentY = centerY;
        
        // Set intro font
        ctx.font = `900 ${introFontSize}px Inter, -apple-system, system-ui, sans-serif`;
        
        // "LAST WEEK" - faded
        ctx.globalAlpha = 0.7;
        ctx.fillText('LAST WEEK', leftMargin, currentY);
        currentY += introSpacing;
        
        // "THERE WERE" - faded  
        ctx.fillText('THERE WERE', leftMargin, currentY);
        currentY += introSpacing;
        
        // "X SHOWS" - highlighted
        ctx.globalAlpha = 1;
        ctx.fillText(`${showCount} SHOWS`, leftMargin, currentY);
        currentY += introSpacing;
        
        // "RUNNING AND" - faded
        ctx.globalAlpha = 0.7;
        ctx.fillText('RUNNING AND', leftMargin, currentY);
        currentY += introSpacing + 70; // Split the difference - 70px space before big number
        
        // Main attendance number - large and highlighted
        ctx.globalAlpha = 1;
        ctx.font = `900 ${attendanceFontSize}px Inter, -apple-system, system-ui, sans-serif`;
        ctx.fillText(attendance, leftMargin, currentY);
        currentY += attendanceSpacing - 90; // Split the difference - "BUTTS IN SEATS" close to the number
        
        // "BUTTS IN SEATS" - faded, back to intro font size
        ctx.globalAlpha = 0.7;
        ctx.font = `900 ${introFontSize}px Inter, -apple-system, system-ui, sans-serif`;
        ctx.fillText('BUTTS IN SEATS', leftMargin, currentY);
        
        return canvas;
      }

      showError(message) {
        const err = document.getElementById("error");
        err.textContent = message;
        err.hidden = false;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      console.log("DOM loaded, creating dashboard...");
      new BroadwayDashboard();
    });
  </script>
</body>
</html>
