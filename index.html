<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BUTTS IN SEATS</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="error" class="error" hidden></div>

  <div id="dashboard">
    <div class="main-screen">
      <section class="data-section">
        <p id="intro-text" class="intro-text"></p>

      </section>
    </div>

    <section class="comparison-section">
      <div class="comparison-header">
        <p class="comparison-intro">
          <span class="intro-faded">THIS WEEK IN </span>
          <span id="year-display" class="year-highlight">2023</span>
          <span class="year-controls">
            <button class="year-btn year-up" aria-label="Previous year">â–²</button>
            <button class="year-btn year-down" aria-label="Next year">â–¼</button>
          </span>
        </p>
        <p class="shows-running-text">
          <span id="historical-shows-display" class="shows-number">32</span>
          <span class="shows-label">SHOWS</span>
          <span class="intro-faded"> WERE RUNNING</span>
        </p>
      </div>
      


    </section>

    <footer class="metadata">
      <p id="week-ending">Week ending: -</p>
      <p id="last-updated">Last updated: -</p>
      <p>
        Data source:
        <a
          href="https://www.broadwayworld.com/grosses.cfm"
          target="_blank"
          rel="noopener noreferrer"
          >BROADWAYWORLD</a
        >
      </p>
      <button id="theme-toggle" aria-label="Toggle dark theme">ðŸŒ“</button>
    </footer>
  </div>

  <script>
    console.log("Script starting...");
    class BroadwayDashboard {
      constructor() {
        this.init();
      }

      async init() {
        await this.loadCurrentData();
        this.setupYearSelector();
        this.setupThemeToggle();
      }

      async loadCurrentData() {
        try {
          const fetchPromise = fetch("/.netlify/functions/broadway-data");
          const timeoutPromise = new Promise((_, reject) =>
            setTimeout(() => reject(new Error("Request timed out")), 5000)
          );
          const res = await Promise.race([fetchPromise, timeoutPromise]);
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          const data = await res.json();

            document.getElementById("intro-text").innerHTML =
              `<span class="intro-faded">LAST WEEK THERE WERE</span> ` +
              `<span class="intro-highlight no-wrap">${data.showCount.toLocaleString()} SHOWS</span><br>` +
              `<span class="intro-faded">RUNNING AND</span> ` +
              `<span class="intro-highlight attendance-number">${data.attendance.toLocaleString()}</span><br>` +
              `<span class="intro-faded no-wrap">BUTTS IN SEATS</span>`;

          

          

          document.getElementById("week-ending").textContent =
            "Week ending: " + data.weekEnding;
          document.getElementById("last-updated").textContent =
            "Last updated: " + data.lastUpdated;
        } catch (err) {
          // Fallback to mock data if the API fails or times out
          console.log("API failed or timed out, using mock data:", err);
          this.loadMockData();
        }
      }

      loadMockData() {
        const mockData = {
          attendance: 217600,
          showCount: 34,
          weekEnding: new Date().toLocaleDateString('en-US', {
            month: 'long',
            day: 'numeric',
            year: 'numeric'
          }),
          lastUpdated: new Date().toLocaleString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            timeZone: 'America/New_York'
          })
        };

          document.getElementById("intro-text").innerHTML =
            `<span class="intro-faded">LAST WEEK THERE WERE</span> ` +
            `<span class="intro-highlight no-wrap">${mockData.showCount.toLocaleString()} SHOWS</span><br>` +
            `<span class="intro-faded">RUNNING AND</span> ` +
            `<span class="intro-highlight attendance-number">${mockData.attendance.toLocaleString()}</span><br>` +
            `<span class="intro-faded no-wrap">BUTTS IN SEATS</span>`;
        

        document.getElementById("week-ending").textContent =
          "Week ending: " + mockData.weekEnding;
        document.getElementById("last-updated").textContent =
          "Last updated: " + mockData.lastUpdated;
      }

      setupYearSelector() {
        const yearDisplay = document.getElementById("year-display");
        const yearUpBtn = document.querySelector(".year-up");
        const yearDownBtn = document.querySelector(".year-down");
        
        // Set initial year (2023)
        let currentYear = 2023;
        yearDisplay.textContent = currentYear;
        
        // Define year range
        const minYear = 1996;
        const maxYear = 2024;
        
        // Function to update year and button visibility
        const updateYear = (newYear) => {
          if (newYear >= minYear && newYear <= maxYear) {
            currentYear = newYear;
            yearDisplay.textContent = currentYear;
            this.loadHistoricalData(currentYear);
            
            // Update button visibility
            yearUpBtn.style.display = currentYear >= maxYear ? 'none' : 'flex';
            yearDownBtn.style.display = currentYear <= minYear ? 'none' : 'flex';
          }
        };
        
        // Set up button event listeners
        yearUpBtn.addEventListener("click", () => {
          if (currentYear < maxYear) {
            updateYear(currentYear + 1);
          }
        });
        
        yearDownBtn.addEventListener("click", () => {
          if (currentYear > minYear) {
            updateYear(currentYear - 1);
          }
        });
        
        // Set initial button visibility
        yearUpBtn.style.display = 'flex'; // Show up arrow initially (2023 < 2024)
        yearDownBtn.style.display = 'flex'; // Show down arrow initially (2023 > 1996)
        
        // Load initial data
        this.loadHistoricalData(currentYear);
      }

      async loadHistoricalData(year) {
        try {
          const week = this.getCurrentWeekNumber();
          const res = await fetch(
            `/.netlify/functions/broadway-historical?year=${year}&week=${week}`
          );
          const data = await res.json();

          document.getElementById("historical-shows-display").textContent =
            data.showCount.toLocaleString();
        } catch (err) {
          // Fallback to mock historical data
          console.log("Historical API failed, using mock data:", err);
          this.loadMockHistoricalData(year);
        }
      }

      loadMockHistoricalData(year) {
        console.log("Loading mock historical data for year:", year);
        
        // Generate more realistic and varied data based on Broadway trends
        let baseAttendance, baseShowCount;
        
        // Base values with year-specific adjustments
        if (year >= 2016 && year <= 2019) {
          // Pre-pandemic era - gradual growth
          baseAttendance = 215000 + (year - 2016) * 2000; // 215k to 221k
          baseShowCount = 32 + (year - 2016); // 32 to 35
        } else if (year === 2020) {
          // Pandemic year - very low
          baseAttendance = 45000;
          baseShowCount = 5;
        } else if (year === 2021) {
          // Recovery year
          baseAttendance = 85000;
          baseShowCount = 15;
        } else if (year === 2022) {
          // More recovery
          baseAttendance = 165000;
          baseShowCount = 30;
        } else if (year === 2023) {
          // Near normal
          baseAttendance = 195000;
          baseShowCount = 32;
        } else if (year === 2024) {
          // Current year
          baseAttendance = 210000;
          baseShowCount = 34;
        } else {
          // Historical years (1996-2015) - gradual growth over time
          const yearsSince1996 = year - 1996;
          baseAttendance = 180000 + (yearsSince1996 * 1200); // 180k to 203k
          baseShowCount = 25 + Math.floor(yearsSince1996 / 2); // 25 to ~33
        }

        // Add some realistic variation (Â±5%)
        const variation = 0.95 + (Math.random() * 0.1); // 95% to 105%
        const attendance = Math.round(baseAttendance * variation);
        const showCount = Math.max(1, Math.round(baseShowCount * variation));

        const mockData = {
          attendance: attendance,
          showCount: showCount
        };

        console.log("Mock data calculated:", mockData);

        document.getElementById("historical-shows-display").textContent =
          mockData.showCount.toLocaleString();

        console.log("Historical data updated in DOM");
      }

      getCurrentWeekNumber() {
        const now = new Date();
        const start = new Date(now.getFullYear(), 0, 1);
        const days = Math.floor((now - start) / 86400000);
        return Math.ceil((days + start.getDay() + 1) / 7);
      }

      setupThemeToggle() {
        const btn = document.getElementById("theme-toggle");
        const root = document.documentElement;
        const stored = localStorage.getItem("theme");
        if (stored) root.setAttribute("data-theme", stored);

        btn.addEventListener("click", () => {
          const current = root.getAttribute("data-theme") === "dark"
            ? "light"
            : "dark";
          root.setAttribute("data-theme", current);
          localStorage.setItem("theme", current);
        });
      }

      showError(message) {
        const err = document.getElementById("error");
        err.textContent = message;
        err.hidden = false;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      console.log("DOM loaded, creating dashboard...");
      new BroadwayDashboard();
    });
  </script>
</body>
</html>
